@using System.IO
@using System.Linq
@using PagedList
@using PagedList.Mvc
@model IPagedList<u22560646_HW3.Models.Product>

@{
    ViewBag.Title = "Products";
    var brands = ViewBag.Brands as IEnumerable<u22560646_HW3.Models.Brand> ?? Enumerable.Empty<u22560646_HW3.Models.Brand>();
    var categories = ViewBag.Categories as IEnumerable<u22560646_HW3.Models.Category> ?? Enumerable.Empty<u22560646_HW3.Models.Category>();
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Products</h3>
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createProductModal">Create Product</button>
    </div>

    <div class="mb-3 d-flex gap-2">
        <select id="brandFilter" class="form-select form-select-sm w-auto" onchange="applyFilters()">
            <option value="">All Brands</option>
            @foreach (var b in brands)
            {
                <option value="@b.BrandId" @(Request.QueryString["brandFilter"] == b.BrandId.ToString() ? "selected" : "")>@b.BrandName</option>
            }
        </select>

        <select id="categoryFilter" class="form-select form-select-sm w-auto" onchange="applyFilters()">
            <option value="">All Categories</option>
            @foreach (var c in categories)
            {
                <option value="@c.CategoryId" @(Request.QueryString["categoryFilter"] == c.CategoryId.ToString() ? "selected" : "")>@c.CategoryName</option>
            }
        </select>
    </div>

    @if (Model != null && Model.Any())
    {
        foreach (var p in Model)
        {
            var brandName = (p.Brand?.BrandName ?? "").Trim().ToLower();
            var prodName = (p.ProductName ?? "").Trim().ToLower();

            // Normalize to match image names
            brandName = brandName.Replace(" ", "_").Replace("-", "_");
            prodName = prodName.Replace(" ", "_").Replace("-", "_");

            var imageUrl = Url.Content("~/Content/Images/default.jpeg");
            var imagesFolder = Server.MapPath("~/Content/Images");

            if (!string.IsNullOrEmpty(imagesFolder) && Directory.Exists(imagesFolder))
            {
                var files = Directory.GetFiles(imagesFolder, "*.jp*");

                var found = files.FirstOrDefault(f =>
                {
                    var name = Path.GetFileNameWithoutExtension(f).ToLower();
                    name = name.Replace(" ", "_").Replace("-", "_");
                    return name.Contains(brandName) || name.Contains(prodName);
                });

                if (found != null)
                {
                    var fname = Path.GetFileName(found);
                    imageUrl = Url.Content("~/Content/Images/" + fname);
                }
            }

            <div class="card mb-3 shadow-sm">
                <div class="row g-0">
                    <div class="col-md-3">
                        <img src="@imageUrl" alt="@p.ProductName" class="img-fluid rounded-start" style="height:160px; width:100%; object-fit:cover;" />
                    </div>
                    <div class="col-md-9">
                        <div class="card-body">
                            <h5 class="card-title mb-1">@p.ProductName</h5>
                            <p class="mb-1 text-muted">@p.Brand.BrandName | @p.Category.CategoryName</p>
                            <p class="mb-1 fw-bold">R @p.ListPrice.ToString("F2")</p>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info">No products available.</div>
    }

    <!-- Pagination -->
    <nav aria-label="Products pagination">
        <ul class="pagination justify-content-center">
            @if (Model != null)
            {
                int pCurrent = Model.PageNumber;
                int pTotal = Model.PageCount;
                int pStart = Math.Max(1, pCurrent - 2);
                int pEnd = Math.Min(pTotal, pCurrent + 2);

                if (pCurrent > 1)
                {
                    <li class="page-item"><a class="page-link" href="@Url.Action("Product", "Home", new { brandFilter = Request.QueryString["brandFilter"], categoryFilter = Request.QueryString["categoryFilter"], page = 1 })">&laquo;</a></li>
                    <li class="page-item"><a class="page-link" href="@Url.Action("Product", "Home", new { brandFilter = Request.QueryString["brandFilter"], categoryFilter = Request.QueryString["categoryFilter"], page = pCurrent - 1 })">&lt;</a></li>
                }

                if (pStart > 1)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }

                for (int i = pStart; i <= pEnd; i++)
                {
                    <li class="page-item @(i == pCurrent ? "active" : "")">
                        <a class="page-link" href="@Url.Action("Product", "Home", new { brandFilter = Request.QueryString["brandFilter"], categoryFilter = Request.QueryString["categoryFilter"], page = i })">@i</a>
                    </li>
                }

                if (pEnd < pTotal)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }

                if (pCurrent < pTotal)
                {
                    <li class="page-item"><a class="page-link" href="@Url.Action("Product", "Home", new { brandFilter = Request.QueryString["brandFilter"], categoryFilter = Request.QueryString["categoryFilter"], page = pCurrent + 1 })">&gt;</a></li>
                    <li class="page-item"><a class="page-link" href="@Url.Action("Product", "Home", new { brandFilter = Request.QueryString["brandFilter"], categoryFilter = Request.QueryString["categoryFilter"], page = pTotal })">&raquo;</a></li>
                }
            }
        </ul>
    </nav>
</div>

<!-- Create Product Modal -->
<div class="modal fade" id="createProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("CreateProduct", "Home", FormMethod.Post, new { enctype = "multipart/form-data" }))
            {
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Create Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    @Html.TextBox("ProductName", null, new { @class = "form-control mb-2", placeholder = "Product name" })
                    <select name="BrandId" class="form-select mb-2">
                        <option value="">Select Brand</option>
                        @foreach (var b in brands)
                        {
                            <option value="@b.BrandId">@b.BrandName</option>
                        }
                    </select>
                    <select name="CategoryId" class="form-select mb-2">
                        <option value="">Select Category</option>
                        @foreach (var c in categories)
                        {
                            <option value="@c.CategoryId">@c.CategoryName</option>
                        }
                    </select>
                    @Html.TextBox("ListPrice", null, new { @class = "form-control mb-2", type = "number", step = "0.01", placeholder = "List Price" })
                    <div class="mb-2">
                        <label class="form-label">Optional: Upload Image</label>
                        <input type="file" name="productImage" accept=".jpg,.jpeg" class="form-control" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            }
        </div>
    </div>
</div>

@section scripts {
    <script>
        function applyFilters() {
            const brand = document.getElementById('brandFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const url = '@Url.Action("Product", "Home")';
            const params = [];
            if (brand) params.push('brandFilter=' + encodeURIComponent(brand));
            if (category) params.push('categoryFilter=' + encodeURIComponent(category));
            window.location = url + (params.length ? '?' + params.join('&') : '');
        }
    </script>
}